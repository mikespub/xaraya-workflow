<?xml version="1.0" encoding="utf-8"?>
<xar:template xmlns:xar="http://xaraya.com/2004/blocklayout">
  <!-- this relies on $config and $item from trackerlist or test_run, or on $workflow, $subjectId, $place and $trackerId if available -->
  <xar:if condition="empty($config)">
    <xar:set name="dummy">sys::import('modules.workflow.class.config')</xar:set>
    <xar:set name="config">xarWorkflowConfig::loadConfig()</xar:set>
  </xar:if>
  <xar:if condition="!empty($trackerId) and empty($workflow) and empty($item)">
    <xar:set name="dummy">sys::import('modules.workflow.class.history')</xar:set>
    <xar:set name="item">xarWorkflowTracker::getTrackerItem($trackerId)</xar:set>
  </xar:if>
  <xar:set name="displaylink">xarServer::getObjectURL($item['object'], 'display', ['itemid' => $item['item']])</xar:set>
  <xar:set name="infolink">xarServer::getObjectURL('workflow_tracker', 'display', ['itemid' => $item['tracker_id']])</xar:set>
  <xar:set name="params">['workflow' => $item['workflow']]</xar:set>
  <xar:set name="workflowlink">xarServer::getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <xar:set name="currentId">implode('.', [$item['object'], (string) $item['item']])</xar:set>
  <xar:set name="params">$params + ['subjectId' => $currentId]</xar:set>
  <xar:set name="subjectlink">xarServer::getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <xar:set name="params">$params + ['trackerId' => $item['tracker_id']]</xar:set>
  <xar:set name="trackerlink">xarServer::getModuleURL('workflow', 'user', 'test', $params)</xar:set>
  <fieldset>
    <legend><a href="#$workflowlink#">#$config[$item['workflow']]['label']#</a></legend>
    <div class="xar-row">
      <div class="xar-col">
        <label>History Id</label>
      </div>
      <div class="xar-col">
        #$item['id']#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Tracker Id</label>
      </div>
      <div class="xar-col">
        <a href="#$infolink#" title="Info Tracker (#$item['id']#) #$currentId#">
          <xar:img scope="theme" file="icons/info.png" class="xar-icon" alt="info"/>
        </a>&#160;
        <a href="#$trackerlink#" title="Filter Tracker (#$item['id']#) #$currentId#">#$item['tracker_id']#</a>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Subject Id</label>
      </div>
      <div class="xar-col">
        <a href="#$displaylink#" title="Display Subject #$currentId#">
          <xar:img scope="theme" file="icons/display.png" class="xar-icon" alt="display"/>
        </a>&#160;
        <a href="#$subjectlink#" title="Filter Subject #$currentId#">#$currentId#</a>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Transition</label>
      </div>
      <div class="xar-col">
        #ucwords(implode(' ', explode('_', $item['transition'])))#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>To Place</label>
      </div>
      <div class="xar-col">
        <xar:set name="placelink">xarServer::getModuleURL('workflow', 'user', 'test', ['workflow' => $item['workflow'], 'place' => $item['marking']])</xar:set>
        <xar:set name="where">ucwords(implode(' ', explode('_', $item['marking'])))</xar:set>
        <a href="#$placelink#" title="Filter Place #$where#">#$where#</a>
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>User Name</label>
      </div>
      <div class="xar-col">
        #xarUser::getVar('name', $item['user'])#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Updated</label>
      </div>
      <div class="xar-col">
        #xarLocale::getFormattedDate('medium',$item['updated'])#
        #xarLocale::getFormattedTime('short',$item['updated'])#
      </div>
    </div>
    <div class="xar-row">
      <div class="xar-col">
        <label>Context</label>
      </div>
      <div class="xar-col">
        <xar:set name="decoded">json_decode($item['context'])</xar:set>
        <xar:set name="encoded">json_encode($decoded, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES)</xar:set>
        <pre>#$encoded#</pre>
      </div>
    </div>
  </fieldset>
</xar:template>
